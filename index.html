<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
<title>Narrator — RP/Story (PWA)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{--bg:#0f1115;--panel:#151822;--muted:#8b90a0;--text:#e6e7eb;--primary:#7aa2ff;--b1:#1b2030;--b2:#222734}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui}
a{color:var(--primary)}
.wrap{display:grid;grid-template-columns:280px 1fr;min-height:100dvh}
@media(max-width:900px){.wrap{grid-template-columns:1fr}}
.sidebar{background:var(--panel);border-right:1px solid #222530;padding:12px;overflow:auto}
.logo{font-weight:700;margin:6px 0 10px}
.small{font-size:12px;color:var(--muted)}
input,select,textarea,button{background:#111524;border:1px solid #272b39;color:var(--text);padding:10px;border-radius:10px}
button{cursor:pointer}
.block{margin:10px 0}
.story button{width:100%;text-align:left;background:#191d29;border:1px solid #272b39;color:var(--text);padding:9px;border-radius:10px;margin-bottom:6px}
.main{display:flex;flex-direction:column;min-height:100dvh}
.top{display:flex;gap:10px;align-items:center;padding:10px 14px;border-bottom:1px solid #222530;background:#0f121a}
.top .right{margin-left:auto}
.chat{flex:1;overflow:auto;padding:16px}
.msg{max-width:820px;margin:0 auto 12px;border-radius:16px;padding:12px}
.bot{background:var(--b1)} .user{background:var(--b2)}
.msg b{color:#a9b4d0} .meta{color:var(--muted);font-size:12px;margin-top:4px}
.composer{position:sticky;bottom:0;border-top:1px solid #222530;background:#0f121a;padding:10px}
.composer form{max-width:820px;margin:0 auto}
textarea{width:100%;min-height:88px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{display:inline-block;font-size:12px;color:#c8cdf0;border:1px solid #3a4160;border-radius:999px;padding:2px 8px}
</style>
<script src="https://unpkg.com/@mlc-ai/web-llm@0.2.48/dist/web-llm.min.js"></script>
<script>
/*** —— Simple account system (client-side) —— ***/
// Passwords (client only; for fun/private use, not high security)
const USERS = {
  "Admin1":"Admin",
  "PS1":"Guest 1","PS2":"Guest 2","PS3":"Guest 3","PS4":"Guest 4","PS5":"Guest 5",
  "PS6":"Guest 6","PS7":"Guest 7","PS8":"Guest 8","PS9":"Guest 9","PS10":"Guest 10"
};
let currentUser=null;

// State helpers (per user + story)
function keyBase(){ const s = storyId.value.trim()||"default"; return `narrator_${currentUser}_${s}`; }
function loadState(){
  const raw=localStorage.getItem(keyBase());
  return raw?JSON.parse(raw):{
    mode:"rp", ooc:false, style:"default",
    model: "Phi-3-mini-4k-instruct-q4f32_1-MLC",
    temperature:1.05, max_tokens:360,
    outline:"", lorebook:"", goal:"", onboarded:false,
    memories:[], history:[]
  };
}
function saveState(st){ localStorage.setItem(keyBase(), JSON.stringify(st)); }

// UI globals
let engine=null;

// System prompt
const STYLE_PRESETS={
  default:"", noir:"STYLE OVERRIDE: moody, staccato, smoky noir tension.",
  romance:"STYLE OVERRIDE: intimate, yearning, soft sensory detail.",
  action:"STYLE OVERRIDE: kinetic verbs, quick cuts, external stakes."
};
function buildSystem(st){
  const modeText = st.mode==="rp" ? "MODE: RP — second-person, interactive; include a small hook/choice." :
                                    "MODE: STORY — third-person mini-chapter; no choices, keep momentum.";
  const oocText  = st.ooc ? "OOC ENABLED: only when the user asks; otherwise stay immersed."
                          : "OOC DISABLED: stay fully in-world.";
  const memBlock = st.memories?.length ? "\n\nMEMORY:\n- "+st.memories.slice(-12).map(m=>m.text).join("\n- ") : "";
  return `ADULTS-ONLY RP/STORY ENGINE — FICTION ONLY
Never provide real-world how-to. Adults only in NSFW. Fade to black if lines are crossed.
STYLE: cinematic, sensory, avoid purple prose; keep continuity; end with a small HOOK.

${STYLE_PRESETS[st.style]||""}
${modeText}
${oocText}

DIALS: ${JSON.stringify({temperature:st.temperature, max_tokens:st.max_tokens, style:st.style})}
OUTLINE: ${st.outline||"[EMPTY]"}
LOREBOOK: ${st.lorebook||"[EMPTY]"}
CURRENT GOAL/BEAT: ${st.goal||"[EMPTY]"}${memBlock}`;
}

// Login
function doLogin(){
  const pw = document.getElementById('pw').value.trim();
  if(USERS[pw]){ currentUser = USERS[pw]; renderShell(); boot(); }
  else document.getElementById('pwmsg').textContent="Invalid password.";
}

// Boot model
async function boot(){
  const st = loadState(); render(st);
  statusTxt.textContent = "Loading model… (first load can take a minute)";
  try{
    engine = await webllm.CreateMLCEngine(st.model, {
      temperature: st.temperature, top_p: 0.92, repetition_penalty: 1.1, context_window_size: 2048
    });
    statusTxt.textContent = "Ready.";
  }catch(e){ statusTxt.textContent = "Failed to load model: "+e; }
}

// Render chat
function render(st){
  // left panel
  modeSel.value = st.mode;  oocSel.value = st.ooc ? "on":"off";
  styleSel.value = st.style; modelSel.value = st.model;
  tempInp.value = st.temperature; tokInp.value = st.max_tokens;
  outline.value = st.outline; lorebook.value = st.lorebook; goal.value = st.goal;
  // message list
  chat.innerHTML = st.history.map(([u,b]) =>
    `<div class="msg user"><b>You</b><div>${escape(u)}</div></div>
     <div class="msg bot"><b>Narrator</b><div>${escape(b)}</div></div>`).join("");
  chat.scrollTop = chat.scrollHeight;
}
function escape(s){return (s||"").replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}

// Shell vs login
function renderShell(){
  document.getElementById('login').style.display="none";
  document.getElementById('app').style.display="grid";
  who.innerHTML = `<span class="badge">${currentUser}</span>`;
}

// Save meta
function saveMeta(){
  const st = loadState();
  st.mode = modeSel.value; st.ooc = (oocSel.value==="on");
  st.style = styleSel.value; st.model = modelSel.value;
  st.temperature = parseFloat(tempInp.value||1.05); st.max_tokens = parseInt(tokInp.value||360,10);
  st.outline = outline.value; st.lorebook = lorebook.value; st.goal = goal.value;
  saveState(st); render(st);
}

// Commands
function handleCommands(text, st){
  if(text.startsWith("/mode ")){ st.mode = text.split(/\s+/,2)[1]==="story"?"story":"rp"; saveState(st); render(st); return true; }
  if(text.startsWith("/ooc ")){ st.ooc  = /on|true/i.test(text.split(/\s+/,2)[1]); saveState(st); render(st); return true; }
  if(text.startsWith("/style ")){ const s=text.split(/\s+/,2)[1]; if(STYLE_PRESETS[s]!=null){st.style=s; saveState(st); render(st);} return true; }
  if(text.startsWith("/beat ")){ st.goal = text.slice(6).trim(); saveState(st); render(st); return true; }
  if(text==="/summary"){ st.history.push(["/summary","(Phone version) Feature coming soon: exportable summaries."]); saveState(st); render(st); return true; }
  if(text.startsWith("/remember ")){
    st.memories.push({id:Date.now().toString().slice(-6), text:text.slice(10).trim()});
    saveState(st); render(st); return true;
  }
  if(text==="/mem"){
    const mems = st.memories.slice(-12).map(m=>`[${m.id}] ${m.text}`).join("\n") || "(none)";
    st.history.push(["/mem", mems]); saveState(st); render(st); return true;
  }
  if(text.startsWith("/forget ")){
    const id = text.split(/\s+/,2)[1]; st.memories = st.memories.filter(m=>m.id!==id);
    saveState(st); render(st); return true;
  }
  if(text==="/reset"){ st.history=[]; st.outline=""; st.lorebook=""; st.goal=""; st.onboarded=false; saveState(st); render(st); return true; }
  return false;
}

// Send
async function sendMsg(ev){
  ev.preventDefault();
  const st = loadState(); const text = msg.value.trim(); if(!text) return;
  if(handleCommands(text, st)){ msg.value=""; return; }
  if(!engine){ alert("Model still loading—give it a moment."); return; }

  st.history.push([text,"..."]); saveState(st); render(st); msg.value="";
  const system = buildSystem(st);
  const keep = st.history.slice(-6).filter(x=>x[1]!=="...");
  const messages=[{role:"system",content:system}];
  keep.forEach(([u,b])=>{messages.push({role:"user",content:u}); messages.push({role:"assistant",content:b});});
  messages.push({role:"user",content:text});

  // onboarding: ask setup Qs if outline empty
  try{
    const out = await engine.chat.completions.create({messages, stream:false, temperature:st.temperature, top_p:0.92, max_gen_len:st.max_tokens});
    const reply = out.choices?.[0]?.message?.content || "[no output]";
    st.history[st.history.length-1][1]=reply;

    // cheap auto-memory extract (very light)
    if(st.memories.length<100){
      const m = reply.match(/(?:remember|note|rule)[:\-]\s*(.+)/i);
      if(m){ st.memories.push({id:Date.now().toString().slice(-6), text:m[1].trim()}); }
    }

    // try to detect when user answered onboarding and synthesize a seed outline
    if(!st.onboarded && !st.outline && /begin|start|sounds good/i.test(text)){
      st.outline = "ACT I: setup & spark\nACT II: complications & reversals\nACT III: climax & resolution";
      st.goal = "Open with the first scene based on the setup.";
      st.onboarded = true;
    }
  }catch(e){
    st.history[st.history.length-1][1] = "[Error] "+e;
  }
  saveState(st); render(st);
}

// Tiny helpers for story list
function storiesForUser(){
  const prefix=`narrator_${currentUser}_`; const keys = Object.keys(localStorage).filter(k=>k.startsWith(prefix));
  return keys.map(k=>k.replace(prefix,""));
}
function refreshStoryList(){
  storyList.innerHTML = storiesForUser().map(s=>`<button onclick="storyId.value='${s}'; render(loadState());">${s}</button>`).join("") || "<div class='small'>No saved stories yet.</div>";
}

window.addEventListener('load', ()=>{
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  refreshStoryList();
});
</script>
</head>
<body>

<!-- Login -->
<div id="login" class="sidebar" style="max-width:520px;margin:10vh auto;border:1px solid #222530;border-radius:14px">
  <div class="logo">Narrator — Login</div>
  <div class="block small">Passwords (client-side): <b>Admin1</b>, <b>PS1…PS10</b></div>
  <div class="row">
    <input id="pw" type="password" placeholder="Enter password">
    <button onclick="doLogin()">Enter</button>
  </div>
  <div id="pwmsg" class="small" style="margin-top:6px;color:#ff9d9d"></div>
  <div class="block small">Tip: on iPhone, once inside, Share → <b>Add to Home Screen</b></div>
</div>

<!-- App -->
<div id="app" class="wrap" style="display:none">
  <aside class="sidebar">
    <div class="logo">Narrator</div>
    <div class="small">Logged in as <span id="who"></span></div>
    <hr style="border:0;border-top:1px solid #222530;margin:10px 0"/>

    <div class="small">Your Stories</div>
    <div id="storyList" class="story block"></div>

    <div class="small">Current Story ID</div>
    <div class="row block">
      <input id="storyId" value="default" oninput="render(loadState())">
      <button onclick="refreshStoryList()">Refresh</button>
    </div>

    <div class="small">Mode · OOC · Style</div>
    <div class="row block">
      <select id="modeSel"><option value="rp">RP</option><option value="story">Story</option></select>
      <select id="oocSel"><option value="off">OOC Off</option><option value="on">OOC On</option></select>
      <select id="styleSel"><option>default</option><option>noir</option><option>romance</option><option>action</option></select>
    </div>

    <div class="small">Model (lighter = faster on iPhone)</div>
    <div class="block">
      <select id="modelSel">
        <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi-3-mini-4k (fast)</option>
        <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC">Llama-3.2 3B (quality↑)</option>
        <option value="Qwen2.5-3B-Instruct-q4f32_1-MLC">Qwen2.5 3B (alt)</option>
      </select>
      <div class="small block" id="statusTxt">Idle</div>
    </div>

    <div class="small">Temp · Max Tokens</div>
    <div class="row block"><input id="tempInp" type="number" step="0.01" min="0.6" max="1.6" value="1.05">
      <input id="tokInp" type="number" min="160" max="800" value="360"></div>

    <div class="small">Outline</div><textarea id="outline" rows="6" class="block"></textarea>
    <div class="small">Lorebook</div><textarea id="lorebook" rows="6" class="block"></textarea>
    <div class="small">Current Goal</div><input id="goal" class="block" placeholder="Your current beat">

    <div class="row"><button onclick="saveMeta()">Save</button></div>
  </aside>

  <section class="main">
    <div class="top">
      <div class="small">Story: <b id="hdrStory"></b></div>
      <div class="right small">Commands: /mode, /ooc, /style, /beat, /remember, /mem, /forget, /reset</div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="composer">
      <form onsubmit="sendMsg(event)">
        <textarea id="msg" placeholder="Tell the Narrator what to build. For a brand new story, describe genre, setting, characters, boundaries—then type ‘begin’ when ready."></textarea>
        <div class="row" style="margin-top:6px">
          <button>Send</button>
          <div class="small">Tip: add to Home Screen for app-like experience.</div>
        </div>
      </form>
    </div>
  </section>
</div>

<script>
const statusTxt = document.getElementById('statusTxt');
const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const modeSel=document.getElementById('modeSel'), oocSel=document.getElementById('oocSel'), styleSel=document.getElementById('styleSel');
const modelSel=document.getElementById('modelSel'), tempInp=document.getElementById('tempInp'), tokInp=document.getElementById('tokInp');
const outline=document.getElementById('outline'), lorebook=document.getElementById('lorebook'), goal=document.getElementById('goal');
const storyList=document.getElementById('storyList'), storyId=document.getElementById('storyId'), who=document.getElementById('who'), hdrStory=document.getElementById('hdrStory');

storyId.addEventListener('input', ()=>{ hdrStory.textContent = storyId.value.trim()||"default"; });
hdrStory.textContent = storyId.value;
</script>
</body>
</html>
